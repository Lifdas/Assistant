<!DOCTYPE html>
<html lang="fr">

<head id="head-placeholder">
    <!-- Font Awesome local -->
    <link rel="stylesheet" href="css/all.min.css">
    <!-- JQUERY -->
    <meta charset="UTF-8">
    <script src="js/jquery3.2.0.min.js"></script>
    <script src="js/jquery3.2.0.treetable.min.js"></script>
    <script src="js/jquery.tablesorter.min.js"></script>
    <script src="js/jquery.tablesorter.pager.js"></script>
    <script src="js/jquery.tablesorter.widgets.js"></script>
    <script src="js/jquery.metadata.js"></script>
    <script src="js/jquery.contextMenu.min.js"></script>
    <!-- Fomantic UI -->
    <link rel="stylesheet" href="css/semantic.min.css">

    <!-- Styles persos -->
    <link rel="stylesheet" href="css/style.css">

    <!-- Alpine.js 3.8.1 (copié de l'ERP) -->
    <script defer src="js/alpinejs3.8.1.js"></script>
    <script defer src="js/app.js"></script>

    <!-- Semantic UI JS -->
    <script defer src="js/semantic.min.js"></script>
    <script src="js/moment-with-locales.min.js"></script>
    <link href="css/app_semantic.css" rel="stylesheet" media="screen">

    <!-- addresses -->
    <link rel="stylesheet" href="css/address.css">
    

</head>

<body x-data="$store.App" x-init="initApp()">
    <!-- Toast Notification -->
    <div x-data="$store.NotifToast" id="toast" style="z-index:9999; border-radius: 5px; border: 2px solid #636363;">
        <div style="position:absolute; top:0px; right: 8px; font-weight:bold;;"
            class="clickable" @click="close()">x</div>
        <div class="b" x-text="$store.NotifToast.title"></div>
        <div x-text="$store.NotifToast.message"></div>
    </div>
    </div>
    <!-- Overlay de connexion -->
    <div x-show="$store.App.showLogin" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0" class="login-overlay" @click.self="false">

        <div class="login-card">
            <!-- En-tête -->
            <div class="login-header">
                <i class="fas fa-user-shield icon"></i>
                <h2>Bienvenue</h2>
                <p style="margin: 0; opacity: 0.9;">Accédez à votre espace</p>
            </div>

            <!-- Contenu -->
            <div class="login-content">
                <!-- Onglets -->
                <div class="tab-menu">
                    <button class="tab-button" :class="{ 'active': !$store.App.showCreate }"
                        @click="$store.App.showCreate = false; $store.App.clearMessages()">
                        <i class="fas fa-sign-in-alt"></i> Connexion
                    </button>
                    <button class="tab-button" :class="{ 'active': $store.App.showCreate }"
                        @click="$store.App.showCreate = true; $store.App.clearMessages()">
                        <i class="fas fa-user-plus"></i> Créer un compte
                    </button>
                </div>

                <!-- Section Connexion -->
                <div class="form-section" :class="{ 'active': !$store.App.showCreate }">
                    <form @submit.prevent="$store.App.attemptLogin()">
                        <div class="field-group">
                            <label>Utilisateur</label>
                            <div class="input-wrapper">
                                <i class="fas fa-user"></i>
                                <input type="text" class="styled-input" placeholder="Entrez votre nom d'utilisateur"
                                    x-model="$store.App.user_logs.login" required />
                            </div>
                        </div>

                        <div class="field-group">
                            <label>Mot de passe</label>
                            <div class="input-wrapper">
                                <i class="fas fa-lock"></i>
                                <input type="password" class="styled-input" placeholder="Entrez votre mot de passe"
                                    x-model="$store.App.user_logs.password" required />
                            </div>
                        </div>

                        <!-- Messages d'erreur -->
                        <div x-show="$store.App.loginError" class="error-message" x-text="$store.App.loginError"></div>

                        <button type="submit" class="action-button primary-button">
                            <i class="fas fa-sign-in-alt"></i> Se connecter
                        </button>
                    </form>
                </div>

                <!-- Section Création de compte -->
                <div class="form-section" :class="{ 'active': $store.App.showCreate }">
                    <form @submit.prevent="$store.App.createAccount()">
                        <div class="field-group">
                            <label>Nom d'utilisateur</label>
                            <div class="input-wrapper">
                                <i class="fas fa-user"></i>
                                <input type="text" class="styled-input" placeholder="Choisissez un nom d'utilisateur"
                                    x-model="$store.App.user_logs.newLogin" required />
                            </div>
                        </div>

                        <div class="field-group">
                            <label>Mot de passe</label>
                            <div class="input-wrapper">
                                <i class="fas fa-lock"></i>
                                <input type="password" class="styled-input" placeholder="Créez un mot de passe sécurisé"
                                    x-model="$store.App.user_logs.newPassword" required />
                            </div>
                        </div>

                        <!-- Messages -->
                        <div x-show="$store.App.createError" class="error-message" x-text="$store.App.createError">
                        </div>
                        <div x-show="$store.App.createSuccess" class="success-message"
                            x-text="$store.App.createSuccess"></div>

                        <button type="submit" class="action-button primary-button">
                            <i class="fas fa-user-plus"></i> Créer le compte
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Application principale -->
    <div class="ui container" style="padding:0px":class="{ 'blurred': $store.App.showLogin }">
        <!-- Navigation -->
        <div class="custom-navigation" style="margin-top: 2rem;">
            <button class="nav-button" @click="$store.App.chargerPage('home')">
                <i class="fas fa-home"></i> Accueil
            </button>
            <button class="nav-button primary" @click="$store.App.chargerPage('expeditions')">
                <i class="fas fa-shipping-fast"></i> Expéditions
            </button>
            <button class="nav-button primary" @click="$store.App.chargerPage('delai')">
                <i class="fas fa-clock"></i> Délai rendements
            </button>
            <button class="nav-button primary" @click="$store.App.chargerPage('address')">
                <i class="fa-solid fa-font-awesome"></i> Coordonnées
            </button>
            <button class="nav-button" @click="$store.App.chargerPage('autres')">
                <i class="fas fa-ellipsis-h"></i> Autres
            </button>
            <div class="nav-spacer"></div>
            <button class="nav-button logout" @click="$store.App.logout()">
                <i class="fas fa-sign-out-alt"></i> Déconnexion
            </button>

        </div>


        <!-- Contenu dynamique -->
        <div id="main-content" class="ui segment" style="margin-top: 2rem;"></div>
    </div>


    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('App', {
                showLogin: true,
                showCreate: false,
                loginError: '',
                createError: '',
                createSuccess: '',
                user_id: null,
                user_logs: {
                    login: '',
                    password: '',
                    newLogin: '',
                    newPassword: '',
                },

                async initApp() {
                    try {
                        // Charger la page d'accueil
                        await this.chargerPage('home');
                        Alpine.store('NotifToast').init();
                    } catch (error) {
                        console.error('Erreur initialisation:', error);
                        this.loginError = 'Erreur de connexion au serveur';
                    }
                },

                async chargerPage(page) {
                    try {
                        const html = await fetch(`pages/${page}.html`).then(res => res.text());
                        document.getElementById('main-content').innerHTML = html;

                        // Exécuter les scripts du contenu injecté
                        document.querySelectorAll('#main-content script').forEach(oldScript => {
                            const newScript = document.createElement('script');
                            if (oldScript.src) {
                                newScript.src = oldScript.src;
                            } else {
                                newScript.textContent = oldScript.textContent;
                            }
                            document.body.appendChild(newScript);
                            oldScript.remove();
                        });
                    } catch (error) {
                        console.error('Erreur chargement page:', error)
                    }
                },

                async checkUpdates() {
                    try {
                        const current = await window.pywebview.api.get_version();
                        const json = await window.pywebview.api.fetch_latest();

                        if (json.error) throw new Error(json.error);
                        if (json.version !== current) {
                            if (confirm(`Nouvelle v${json.version} disponible.\nNotes:\n${json.notes}\n\nVoulez-vous télécharger ?`)) {
                                window.open(json.url, '_blank');
                            }
                        } else {
                            alert("Vous êtes à jour !");
                        }
                    } catch (e) {
                        console.error(e);
                        alert("Erreur vérification MAJ : " + e.message);
                    }
                },

                async attemptLogin() {
                    this.clearMessages();
                    try {
                        const response = await window.pywebview.api.login(
                            this.user_logs.login,
                            this.user_logs.password
                        );

                        if (response) {
                            this.user_id = response.id;
                            this.user_login = response.login;
                            this.showLogin = false;
                            this.login.password = '';
                        }
                    } catch (error) {
                        console.error('Erreur connexion:', error);
                        this.loginError = error.message;
                    }
                },

                async createAccount() {
                    this.clearMessages();

                    try {
                        await window.pywebview.api.create_user(
                            this.user_logs.newLogin,
                            this.user_logs.newPassword
                        ).then(res => {
                            console.log(res.rs)
                            console.log(res.user)
                            if (res.rs !== true) {
                                throw new Error(res.error);
                            }

                            // Afficher message de succès
                            this.createSuccess = 'Compte créé avec succès ! Vous pouvez maintenant vous connecter.';

                            // Réinitialiser les champs
                            this.user_logs.newLogin = '';
                            this.user_logs.newPassword = '';

                            // Basculer vers l'onglet connexion après 2 secondes
                            setTimeout(() => {
                                this.showCreate = false;
                                this.clearMessages();
                            }, 2000);


                        })
                            .catch(error => {
                                console.error('Erreur création compte:', error);
                                this.createError = 'Erreur de connexion au serveur';
                                return { error: 'Erreur de connexion au serveur' };
                            });


                    } catch (error) {
                        console.error('Erreur création compte:', error);
                        this.createError = 'Erreur de connexion au serveur';
                    }
                },

                logout() {
                    if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                        this.showLogin = true;
                        this.login.user = '';
                        this.login.password = '';
                        this.clearMessages();
                    }
                },

                clearMessages() {
                    this.loginError = '';
                    this.createError = '';
                    this.createSuccess = '';
                },

            });
        });
    </script>
</body>


</html>