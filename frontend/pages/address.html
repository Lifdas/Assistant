<div x-data="$store.address" x-init="mounted()">
    <button class="create-planet-btn" @click="isShow = !isShow">
        <i class="fas fa-plus"></i>
        Créer une planète
    </button>

    <!-- Le formulaire flottant -->
    <div x-show="isShow" x-transition class="floating-form">
        <form>
            <div class="form-group">
                <label class="form-label">Nom de la planète</label>
                <input type="text" x-model="form.nom" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label">Coordonnées <br>(Galaxie : Secteur : Emplacement)</label>
                <div class="coordinates-row">
                    <input type="number" x-model="form.galaxie" class="coord-input" required>
                    <input type="number" x-model="form.secteur" class="coord-input" required>
                    <input type="number" x-model="form.emplacement" class="coord-input" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Notes</label>
                <input type="text" x-model="form.notes" class="form-input" placeholder="QG, Deuté, Avant poste">
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" x-model="form.lune" id="lune">
                        <label for="lune">Lune</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" x-model="form.porte" id="porte">
                        <label for="porte">Porte de saut spatial</label>
                    </div>
                </div>
            </div>

            <button class="submit-btn" type='button' @click="saveAddress()">
                <i class="fas fa-check"></i> Ajouter
            </button>
        </form>
    </div>

    <!-- La liste des planètes -->
    <div>
        <template x-for="(joueur, jIndex) in planetesList" :key="jIndex">
            <div class="player-section">
                <h3 class="player-title" x-text="joueur.login"></h3>

                <div class="planets-grid">
                    <template x-for="(planete, pIndex) in joueur.planetes" :key="pIndex">
                        <div class="planet-card" @click="open_details(planete)">
                            <div class="planet-name" x-text="planete.nom"></div>
                            <div class="planet-coordinates"
                                x-text="planete.galaxie + ':' + planete.secteur + ':' + planete.emplacement"></div>
                            <div class="planet-notes" x-text="planete.notes"></div>
                            <div class="planet-features">
                                <div x-show="planete.lune" class="feature-icon moon-icon">
                                    <i class="fas fa-moon"></i>
                                </div>
                                <div x-show="planete.porte" class="feature-icon portal-icon">
                                    <i class="fas fa-rocket"></i>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </template>
    </div>
</div>

<script>
    Alpine.store('address', {
        isShow: false,
        form: {
            nom: '',
            galaxie: '',
            secteur: '',
            emplacement: '',
            notes: '',
            lune: false,
            porte: false
        },

        planetesList: [],

        mounted() {
            this.search_address();
        },

        async search_address() {
            await pywebview.api.get_all_addresses()
                .then(response => {
                    this.planetesList = response;
                })
                .catch(error => {
                    console.error('Erreur lors de la récupération des planètes:', error);
                });
        },

        async saveAddress() {
            console.log(this.form)
            try {
                await pywebview.api.create_address(this.form)
                    .then(response => {
                        if (response) {
                            Alpine.store('NotifToast').success('Planète mises à jour avec succès').show()
                            this.resetForm();
                            this.isShow = false;
                        }
                    });
            } catch (e) {
                console.error('Erreur lors de la sauvegarde de l\'adresse:', e);
            }
        },

        resetForm() {
            this.form.nom = '';
            this.form.galaxie = '';
            this.form.secteur = '';
            this.form.emplacement = '';
            this.form.notes = '';
            this.form.lune = false;
            this.form.porte = false;
        },

        open_details(planete) {
            window.pywebview.api.open_planet_window(planete.id)
        }
    });
    
    window.handlePlanetUpdate = function (planetId, updatedData) {
        console.log("Planète mise à jour:", planetId, updatedData);

        // Si vous utilisez Alpine.js dans la fenêtre parent
        if (typeof Alpine !== 'undefined' && Alpine.store('address')) {
            // Recharger toutes les données
            Alpine.store('address').search_address();

            // OU mise à jour ciblée (plus efficace)
            const store = Alpine.store('address');
            for (let i = 0; i < store.planetesList.length; i++) {
                const joueur = store.planetesList[i];
                for (let j = 0; j < joueur.planetes.length; j++) {
                    if (joueur.planetes[j].id == planetId) {
                        // Mettre à jour directement les données
                        Object.assign(joueur.planetes[j], updatedData);
                        return;
                    }
                }
            }
        }
    };
    // Gestionnaire pour les suppressions de planètes
    window.handlePlanetDelete = function (planetId) {
        console.log("Planète supprimée:", planetId);

        if (typeof Alpine !== 'undefined' && Alpine.store('address')) {
            const store = Alpine.store('address');
            for (let i = 0; i < store.planetesList.length; i++) {
                const joueur = store.planetesList[i];
                for (let j = 0; j < joueur.planetes.length; j++) {
                    if (joueur.planetes[j].id == planetId) {
                        // Supprimer la planète de la liste
                        joueur.planetes.splice(j, 1);
                        return;
                    }
                }
            }
        }
    };
</script>