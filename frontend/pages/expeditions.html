<div x-data="$store.expeditions" x-init="mounted()">
  <div class="ui segment" style="max-height: 600px; overflow-y: auto; padding: 0;">
    <table class="ui fixed celled selectable table" style="table-layout: fixed; width: 100%; min-width: 600px;">
      <!-- 3) On peut préciser des largeurs de colonnes si désiré -->
      <colgroup>
        <col style="width: 200px;"> <!-- Date -->
        <col style="width: 160px;"> <!-- Secteur -->
        <col style="width: 120px;"> <!-- Ressources -->
        <col style="width: 120px;"> <!-- Montant -->
        <col style="width: 100px;"> <!-- Actions -->
      </colgroup>

      <thead>
        <tr>
          <th>Date & Heure</th>
          <th>Secteur</th>
          <th>Ressources</th>
          <th>Valeur USM</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="5" class="center aligned">

            <button class="ui green icon button" @click="add_row()" title="Ajouter une ligne">
              <i class="fas fa-square-plus"></i>
            </button>
          </td>
        </tr>
        <template x-for="(exp, index) in expeditions" :key="index">
          <tr>
            <td>
              <div class="ui input">
                <!-- 1) input date -->
                <input type="datetime-local" x-model="exp.date_expedition" @change="exp.has_changed = true" required />
                <!-- 2) bouton copier (désactivé si index===0) -->
                <button class="ui icon button" @click="copy_date(index)" title="Copier la date précédente"
                  x-show="!exp.date_expedition">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </td>
            <td>
              <div class="ui input">
                <input type="number" x-model="exp.secteur" min="1" @change="exp.has_changed = true"
                  placeholder="ex: 209" style="width: 100px;" />
                <button class="ui icon button" @click="copy_secteur(index)" title="Copier le secteur précédent"
                  x-show="!exp.secteur">
                  <i class="fas fa-arrow-down"></i>
                </button>
                <button class="ui icon button" @click="copying_secteur(index)" title="Copier le secteur"
                  x-show="!copying && exp.secteur">
                  <i class="fa-solid fa-copy"></i>
                </button>
                  <button class="ui icon button" @click="delete_secteur(index)" title="Supprimer le secteur"
                  x-show="exp.secteur">
                  <i class="fa-solid fa-eraser"></i>
                </button>
                <button class="ui icon button" @click="paste_secteur(index)" title="Coller le secteur"
                  x-show="copying && !exp.secteur">
                  <i class="fa-solid fa-paste"></i>
                </button>

              </div>
            </td>
            <td>
              <div class="ui input">
                <select x-model="exp.ressources" class="ui dropdown" style="width: 120px;"
                  @change="exp.has_changed = true">
                  <option value="rien">rien</option>
                  <option value="metal">Métal</option>
                  <option value="cristal">Cristal</option>
                  <option value="deuterium">Deutérium</option>
                  <option value="antimatiere">AntiMatière</option>
                  <option value="vaisseaux">Vaisseaux</option>
                </select>
              </div>
            </td>

            <td>
              <div class="ui input" style="width: 120px;">
                <input type="text" x-model="getDisplayValue(exp)" @focus="startEditingSimple(exp, $event)"
                  @blur="finishEditingSimple(exp, $event)" @input="exp.new_expedition = true" placeholder="Montant" />
              </div>
            </td>
            <td>
              <div class="row">
                <button class="ui red icon button tiny" @click="remove_row(exp.id, index)" title="Supprimer la ligne">
                  <i class="fa fa-trash"></i>
                </button>
                <button class="ui primary button tiny" x-show="exp.new_expedition" @click="save_expedition(exp)">
                  <i class="fas fa-save"></i>
                </button>
                <button class="ui primary button tiny" x-show="exp.has_changed && !exp.new_expedition" @click="update_expedition(exp)">
                  <i class="fas fa-refresh"></i>
                </button>
              </div>
            </td>
          </tr>
        </template>

      </tbody>
    </table>
  </div>
</div>

<script>
  Alpine.store('expeditions', {
    expeditions: [],
    copying: false,
    copy: '',

    mounted() {
      // Initialisation avec une ligne vide
      this.show();
      this.add_row();
      console.log(this.copying)
    },

    async show() {
      try {
        await pywebview.api.get_datas(/* args si besoin */)
          .then(data => {
            console.log(data)
            this.expeditions = data;
          })
      } catch (e) {
        console.error('Erreur Python:', e);
      }
    },

    add_row() {
      // Pousse une nouvelle expédition en première position
      this.expeditions.unshift({
        secteur: '',
        ressources: '',
        date_expedition: '',
        new_expedition: true,
        valeur_usm: 0,
      });
    },

    remove_row(id, index) {
      if(!id){
        this.expeditions.splice(index, 1);
      }
      else{
      pywebview.api.delete_expedition(id)
        .then(() => {
          console.log("Expédition supprimée avec succès");
          this.expeditions.splice(index, 1);
        })
        .catch(err => {
          console.error("Erreur lors de la suppression de l'expédition:", err);
        });
      }
    },


    save_expedition(expedition) {
      // Envoie les données des expéditions à l'API Python
      pywebview.api.save_expedition(expedition)
        .then(() => {
          console.log("Expéditions enregistrées avec succès");
          expedition.new_expedition = false;
          expedition.has_changed = false;
        })
        .catch(err => {
          console.error("Erreur lors de l'enregistrement de l'expédition:", err);
        });
    },

    update_expedition(expedition) {
      // Envoie les données des expéditions à l'API Python
      pywebview.api.update_expedition(expedition)
        .then(() => {
          console.log("Expéditions mises à jour avec succès");
          expedition.has_changed = false;
        })
        .catch(err => {
          console.error("Erreur lors de la mise à jour de l'expédition:", err);
        });
    },

    copy_date(i) {
      if (this.expeditions[i + 1].date != 0) {
        this.expeditions[i].date_expedition = this.expeditions[i + 1].date_expedition;

      }
    },

    // concerne le champ secteur
    copy_secteur(i) {
      if (this.expeditions[i + 1].secteur != '') {
        this.expeditions[i].secteur = this.expeditions[i + 1].secteur;
      }
    },

    copying_secteur(i) {
      this.copying = true;
      this.copy = this.expeditions[i].secteur;
    },

    paste_secteur(i) {
      if (this.copying && this.copy != '') {
        this.expeditions[i].secteur = this.copy;
        this.copy = '';
        this.copying = false;
        this.expeditions[i].has_changed = true; 
      }
    },

    delete_secteur(i) {
      this.expeditions[i].secteur = '';
      this.expeditions[i].has_changed = true; 
    },

    // concerne le champ valeur usm
    formatValue(val) {
      if (val == null || val === '') return '';
      const n = Number(val);
      if (isNaN(n)) return val;
      // Abréviations
      if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + ' M';
      if (n >= 100_000) return Math.round(n / 1_000) + ' k';
      if (n >= 10_000) return (n / 1_000).toFixed(1) + ' k';
      // Séparateurs de milliers
      return new Intl.NumberFormat('fr-FR').format(n);
    },

    getDisplayValue(exp) {
      return exp.editing ? exp.valeur_usm : this.formatValue(exp.valeur_usm);
    },

    startEditingSimple(exp, event) {
      exp.editing = true;
      event.target.value = exp.valeur_usm || '';
      event.target.select();
    },

    finishEditingSimple(exp, event) {
      exp.editing = false;
      const value = event.target.value;
      exp.valeur_usm = value === '' ? '' : Number(value);
      event.target.value = this.formatValue(exp.valeur_usm);
    }

  });

</script>